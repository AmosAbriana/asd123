<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ–º</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            flex-shrink: 0;
        }

        .month-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-btn {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            min-width: 45px;
        }

        .nav-btn:active {
            opacity: 0.7;
        }

        .month-year {
            font-weight: bold;
            font-size: 18px;
            min-width: 150px;
            text-align: center;
        }

        .tools {
            display: flex;
            gap: 10px;
            padding: 10px 15px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            flex-shrink: 0;
        }

        .tool-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--tg-theme-button-color, #3390ec);
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-button-color, #3390ec);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tool-btn.active {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .tool-btn:active {
            opacity: 0.7;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: var(--tg-theme-bg-color, #ffffff);
        }

        .calendar-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: auto repeat(6, 1fr);
            gap: 1px;
            background: var(--tg-theme-hint-color, #e0e0e0);
            padding: 1px;
        }

        .weekday-header {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            padding: 8px 4px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .day-cell-bg {
            background: var(--tg-theme-bg-color, #ffffff);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 5px;
            min-height: 60px;
        }

        .day-number {
            font-size: 14px;
            font-weight: 500;
            color: var(--tg-theme-text-color, #000000);
            z-index: 1;
        }

        .day-cell-bg.today {
            background: rgba(51, 144, 236, 0.1);
        }

        .day-cell-bg.today .day-number {
            color: var(--tg-theme-button-color, #3390ec);
            font-weight: bold;
        }

        .drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            touch-action: none;
            cursor: crosshair;
        }

        .drawing-canvas.eraser {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"><circle cx="12" cy="12" r="10" fill="none" stroke="red" stroke-width="2"/></svg>') 12 12, auto;
        }

        .status-bar {
            padding: 10px 15px;
            text-align: center;
            font-size: 13px;
            color: var(--tg-theme-hint-color, #999999);
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-top: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            flex-shrink: 0;
        }

        .save-btn {
            width: 100%;
            padding: 15px;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 0;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            flex-shrink: 0;
        }

        .save-btn:active {
            opacity: 0.7;
        }

        .clear-btn {
            padding: 8px 15px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 10px;
        }

        .clear-btn:active {
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="month-nav">
            <button class="nav-btn" id="prevMonth">‚óÄÔ∏è</button>
            <div class="month-year" id="monthYear"></div>
            <button class="nav-btn" id="nextMonth">‚ñ∂Ô∏è</button>
        </div>
        <button class="clear-btn" id="clearBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <div class="tools">
        <button class="tool-btn active" id="pencilBtn">‚úèÔ∏è –ö–∞—Ä–∞–Ω–¥–∞—à</button>
        <button class="tool-btn" id="eraserBtn">üßπ –õ–∞—Å—Ç–∏–∫</button>
    </div>

    <div class="canvas-container">
        <div class="calendar-background" id="calendarBackground"></div>
        <canvas class="drawing-canvas" id="drawingCanvas"></canvas>
    </div>

    <div class="status-bar" id="status">–†–µ–∂–∏–º –∫–∞—Ä–∞–Ω–¥–∞—à–∞: —Ä–∏—Å—É–π—Ç–µ –Ω–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ</div>
    <button class="save-btn" id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        let currentDate = new Date();
        let currentMode = 'pencil'; // 'pencil' or 'eraser'
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const calendarBg = document.getElementById('calendarBackground');

        const monthNames = [
            '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
            '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
        ];

        const weekdays = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ canvas
        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ä–∏—Å—É–Ω–æ–∫
            loadDrawing();
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function isValidDate(year, month, day) {
            const date = new Date(year, month - 1, day);
            const minDate = new Date(2023, 0, 1);
            const maxDate = new Date(2027, 11, 31);
            return date >= minDate && date <= maxDate;
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('monthYear').textContent = 
                `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = (firstDay.getDay() + 6) % 7; // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ = 0

            calendarBg.innerHTML = '';

            // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
            weekdays.forEach(day => {
                const header = document.createElement('div');
                header.className = 'weekday-header';
                header.textContent = day;
                calendarBg.appendChild(header);
            });

            // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –≤ –Ω–∞—á–∞–ª–µ
            for (let i = 0; i < startDay; i++) {
                const cell = document.createElement('div');
                cell.className = 'day-cell-bg';
                calendarBg.appendChild(cell);
            }

            // –î–Ω–∏ –º–µ—Å—è—Ü–∞
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                const date = new Date(year, month, day);
                
                cell.className = 'day-cell-bg';
                if (isToday(date)) {
                    cell.classList.add('today');
                }

                const dayNum = document.createElement('div');
                dayNum.className = 'day-number';
                dayNum.textContent = day;
                cell.appendChild(dayNum);

                calendarBg.appendChild(cell);
            }

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —è—á–µ–π–∫–∏ –¥–æ –∫–æ–Ω—Ü–∞ —Å–µ—Ç–∫–∏ (6 –Ω–µ–¥–µ–ª—å)
            const totalCells = 7 * 6; // 7 –¥–Ω–µ–π * 6 –Ω–µ–¥–µ–ª—å
            const filledCells = startDay + daysInMonth;
            for (let i = filledCells; i < totalCells; i++) {
                const cell = document.createElement('div');
                cell.className = 'day-cell-bg';
                calendarBg.appendChild(cell);
            }

            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º canvas –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
            setTimeout(() => {
                resizeCanvas();
            }, 100);
        }

        // –§—É–Ω–∫—Ü–∏–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
        function getEventPos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            let clientX, clientY;
            
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;
            const pos = getEventPos(e);
            lastX = pos.x;
            lastY = pos.y;
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            
            const pos = getEventPos(e);
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(pos.x, pos.y);
            
            if (currentMode === 'pencil') {
                ctx.strokeStyle = '#3390ec';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
            } else if (currentMode === 'eraser') {
                ctx.strokeStyle = 'rgba(255, 255, 255, 1)';
                ctx.lineWidth = 20;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.globalCompositeOperation = 'destination-out';
            }
            
            ctx.stroke();
            
            if (currentMode === 'eraser') {
                ctx.globalCompositeOperation = 'source-over';
            }
            
            lastX = pos.x;
            lastY = pos.y;
        }

        function stopDrawing(e) {
            if (isDrawing) {
                e.preventDefault();
                isDrawing = false;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –º—ã—à–∏
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseleave', stopDrawing);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–∞—Å–∞–Ω–∏–π
        canvas.addEventListener('touchstart', startDrawing, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', stopDrawing, { passive: false });
        canvas.addEventListener('touchcancel', stopDrawing, { passive: false });

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('pencilBtn').classList.toggle('active', mode === 'pencil');
            document.getElementById('eraserBtn').classList.toggle('active', mode === 'eraser');
            canvas.classList.toggle('eraser', mode === 'eraser');
            
            const status = document.getElementById('status');
            if (mode === 'pencil') {
                status.textContent = '–†–µ–∂–∏–º –∫–∞—Ä–∞–Ω–¥–∞—à–∞: —Ä–∏—Å—É–π—Ç–µ –Ω–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ';
            } else if (mode === 'eraser') {
                status.textContent = '–†–µ–∂–∏–º –ª–∞—Å—Ç–∏–∫–∞: —Å—Ç–∏—Ä–∞–π—Ç–µ —Ä–∏—Å—É–Ω–∫–∏';
            }
        }

        function saveDrawing() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1;
            const monthKey = `${year}-${String(month).padStart(2, '0')}`;
            
            const imageData = canvas.toDataURL('image/png');
            
            const data = {
                action: 'save_drawing',
                month: monthKey,
                drawing: imageData
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            localStorage.setItem(`drawing_${monthKey}`, imageData);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –±–æ—Ç
            tg.sendData(JSON.stringify(data));
            tg.showAlert('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
        }

        function loadDrawing() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1;
            const monthKey = `${year}-${String(month).padStart(2, '0')}`;
            
            const savedDrawing = localStorage.getItem(`drawing_${monthKey}`);
            if (savedDrawing) {
                const img = new Image();
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                };
                img.src = savedDrawing;
            }
        }

        function clearCanvas() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —Ä–∏—Å—É–Ω–æ–∫ –Ω–∞ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ?')) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                localStorage.removeItem(`drawing_${monthKey}`);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('pencilBtn').addEventListener('click', () => setMode('pencil'));
        document.getElementById('eraserBtn').addEventListener('click', () => setMode('eraser'));
        document.getElementById('saveBtn').addEventListener('click', saveDrawing);
        document.getElementById('clearBtn').addEventListener('click', clearCanvas);

        document.getElementById('prevMonth').addEventListener('click', () => {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ä–∏—Å—É–Ω–æ–∫ –ø–µ—Ä–µ–¥ —Å–º–µ–Ω–æ–π –º–µ—Å—è—Ü–∞
            saveDrawing();
            
            currentDate.setMonth(currentDate.getMonth() - 1);
            if (!isValidDate(currentDate.getFullYear(), currentDate.getMonth() + 1, 1)) {
                currentDate.setMonth(currentDate.getMonth() + 1);
                tg.showAlert('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ø—Ä–µ–¥–µ–ª –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç');
                return;
            }
            renderCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ä–∏—Å—É–Ω–æ–∫ –ø–µ—Ä–µ–¥ —Å–º–µ–Ω–æ–π –º–µ—Å—è—Ü–∞
            saveDrawing();
            
            currentDate.setMonth(currentDate.getMonth() + 1);
            if (!isValidDate(currentDate.getFullYear(), currentDate.getMonth() + 1, 1)) {
                currentDate.setMonth(currentDate.getMonth() - 1);
                tg.showAlert('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ø—Ä–µ–¥–µ–ª –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç');
                return;
            }
            renderCalendar();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('resize', resizeCanvas);
        renderCalendar();
        resizeCanvas();
    </script>
</body>
</html>
